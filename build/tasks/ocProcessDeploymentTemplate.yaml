apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: oc-process-deployment-template
spec:
  params:
    - name: appTemplateFileName
      default: ""
      Description: Application deployment template file
      type: string
    - name: serviceTemplateFileName
      default: ""
      Description: Service deployment template file
      type: string
    - name: routeTemplateFileName
      default: ""
      Description: Route deployment template file
      type: string
    - name: appName
      default: ""
      Description: Name of the application to be deployed
      type: string
    - name: appGroup
      default: ""
      Description: Application grouping within the topology view of the OpenShift web UI
      type: string
  resources:
    inputs:
      - name: source
        type: git
      - name: runtime-image
        type: image
  steps:
    - name: view-git-files
      resources: {}
      command:
        - ls
        - -al
        - /workspace/source/$(params.templateFileName)
      image: image-registry.openshift-image-registry.svc:5000/openshift/cli:latest
      volumeMounts:
        - name: deployment-files
          mountPath: /deployment-files
      workingDir: /deployment-files
    - name: gen-oc-process-script
      command:
        - /bin/sh
        - '-c'
      args:
        - |-
          echo "oc process -f /workspace/source/$(params.appTemplateFileName) -p APP_NAME=$(params.appName) -p APP_GROUP=$(params.appGroup) -p APP_IMAGE=$(resources.inputs.runtime-image.url) > app-deploy.yaml" > oc-process-cmd.sh
          echo "oc process -f /workspace/source/$(params.serviceTemplateFileName) -p APP_NAME=$(params.appName) > service-deploy.yaml" >> oc-process-cmd.sh
          echo "oc process -f /workspace/source/$(params.routeTemplateFileName) -p APP_NAME=$(params.appName) > route-deploy.yaml" >> oc-process-cmd.sh
          echo "Generated oc process script command"
          cat oc-process-cmd.sh
          chmod a+x oc-process-cmd.sh
          ./oc-process-cmd.sh
      image: image-registry.openshift-image-registry.svc:5000/openshift/cli:latest
      volumeMounts:
        - name: deployment-files
          mountPath: /deployment-files
      workingDir: /deployment-files
    - name: oc-create-resources
      resources: {}
      command:
        - oc
        - create
        - '-f'
        - deployment-resources.yaml
      image: image-registry.openshift-image-registry.svc:5000/openshift/cli:latest
      volumeMounts:
        - name: deployment-files
          mountPath: /deployment-files
      workingDir: /deployment-files
    - name: oc-get-resources
      resources: {}
      command:
        - oc
        - get
        - all
      image: image-registry.openshift-image-registry.svc:5000/openshift/cli:latest
    - name: view-deployment-files
      resources: {}
      command:
        - ls
        - -alR
        - /deployment-files
      image: image-registry.openshift-image-registry.svc:5000/openshift/cli:latest
      volumeMounts:
        - name: deployment-files
          mountPath: /deployment-files
      workingDir: /deployment-files
  volumes:
    - emptyDir: {}
      name: deployment-files
